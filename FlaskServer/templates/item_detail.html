{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12 mb-3">
            {% if item_type == 'lost' %}
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('browse_items') }}">Browse Items</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Lost Item Details</li>
                </ol>
            </nav>
            {% else %}
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('browse_items') }}">Browse Items</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Found Item Details</li>
                </ol>
            </nav>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    {% if item_type == 'lost' %}
                    <span class="badge bg-primary">{{ item['category_name'] }}</span>
                    <h5 class="mb-0">Lost on {{ item['date_lost'].strftime('%b %d, %Y') }}</h5>
                    {% else %}
                    <span class="badge bg-success">{{ item['category_name'] }}</span>
                    <h5 class="mb-0">Found on {{ item['date_found'].strftime('%b %d, %Y') }}</h5>
                    {% endif %}
                </div>
                
                <div class="card-body">
                    <h3 class="card-title">{{ item['title'] }}</h3>
                    
                    <div class="row mb-4 mt-3">
                        {% if item['image_filename'] %}
                        <div class="col-md-5 mb-3">
                            <img src="{{ url_for('static', filename='uploads/' + item['image_filename']) }}" 
                                 class="img-fluid rounded" alt="{{ item['title'] }}">
                        </div>
                        <div class="col-md-7">
                        {% else %}
                        <div class="col-12">
                        {% endif %}
                            <div class="item-details">
                                <p class="card-text">{{ item['description'] }}</p>
                                
                                <dl class="row mt-3">
                                    {% if item_type == 'lost' %}
                                    <dt class="col-sm-4">Location Lost:</dt>
                                    <dd class="col-sm-8">{{ item['location_lost'] }}</dd>
                                    {% else %}
                                    <dt class="col-sm-4">Location Found:</dt>
                                    <dd class="col-sm-8">{{ item['location_found'] }}</dd>
                                    {% endif %}
                                    
                                    {% if item['color'] %}
                                    <dt class="col-sm-4">Color:</dt>
                                    <dd class="col-sm-8">{{ item['color'] }}</dd>
                                    {% endif %}
                                    
                                    {% if item['brand'] %}
                                    <dt class="col-sm-4">Brand:</dt>
                                    <dd class="col-sm-8">{{ item['brand'] }}</dd>
                                    {% endif %}
                                    
                                    {% if item_type == 'lost' and item['reward'] %}
                                    <dt class="col-sm-4">Reward:</dt>
                                    <dd class="col-sm-8">
                                        <span class="badge bg-success">{{ item['reward'] }}</span>
                                    </dd>
                                    {% endif %}
                                    
                                    <dt class="col-sm-4">Status:</dt>
                                    <dd class="col-sm-8">
                                        {% if item_type == 'lost' %}
                                            {% if item['is_resolved'] %}
                                            <span class="badge bg-success">Resolved</span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">Still Lost</span>
                                            {% endif %}
                                        {% else %}
                                            {% if item['is_claimed'] %}
                                            <span class="badge bg-success">Claimed</span>
                                            {% else %}
                                            <span class="badge bg-info">Unclaimed</span>
                                            {% endif %}
                                        {% endif %}
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5><i class="fas fa-hands-helping me-2"></i>Contact Information</h5>
                            <p>{{ item['contact_info'] }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Reported on {{ item['created_at'].strftime('%b %d, %Y at %H:%M') }}
                        </small>
                        
                        {% if item_type == 'found' and not item['is_claimed'] and current_user %}
                        <form method="POST" action="{{ url_for('claim_item', item_id=item['id']) }}">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-hand-paper me-2"></i>Claim This Item
                            </button>
                        </form>
                        {% elif item_type == 'lost' and current_user and item['user_id'] == current_user['id'] and not item['is_resolved'] %}
                        <form method="POST" action="{{ url_for('resolve_lost', item_id=item['id']) }}">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check-circle me-2"></i>Mark as Resolved
                            </button>
                        </form>
                        {% elif item_type == 'lost' and current_user and item['user_id'] != current_user['id'] and not item['is_resolved'] %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#foundItemModal">
                            <i class="fas fa-search-plus me-2"></i>I Found This Item
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Share and Report buttons -->
            <div class="d-flex justify-content-between mb-4">
                <button class="btn btn-outline-primary" onclick="copyToClipboard(window.location.href)">
                    <i class="fas fa-share-alt me-2"></i>Share
                </button>
                
                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#reportModal">
                    <i class="fas fa-flag me-2"></i>Report Issue
                </button>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card bg-light shadow-sm mb-4">
                <div class="card-body">
                    {% if item_type == 'lost' %}
                    <h5 class="card-title"><i class="fas fa-lightbulb me-2 text-warning"></i>Have You Found This?</h5>
                    <p class="card-text mt-3">
                        If you think you've found this item, contact the owner using the information provided.
                        Please verify that it's the correct item by asking for specific details only the owner would know.
                    </p>
                    <div class="d-grid gap-2 mt-3">
                        <a href="{{ url_for('report_found') }}" class="btn btn-success">
                            <i class="fas fa-plus-circle me-2"></i>Report a Different Found Item
                        </a>
                    </div>
                    {% else %}
                    <h5 class="card-title"><i class="fas fa-lightbulb me-2 text-warning"></i>Is This Yours?</h5>
                    <p class="card-text mt-3">
                        If you believe this is your item, you can claim it by clicking the "Claim This Item" button.
                        Be prepared to provide specific details about the item to prove ownership.
                    </p>
                    <div class="d-grid gap-2 mt-3">
                        <a href="{{ url_for('report_lost') }}" class="btn btn-primary">
                            <i class="fas fa-plus-circle me-2"></i>Report a Different Lost Item
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2 text-info"></i>Similar Items</h5>
                </div>
                <div class="card-body">
                    {% if item_type == 'lost' %}
                    <p class="card-text">Check out these similar found items that might match what you're looking for:</p>
                    <!-- In a real app, we would show similar found items based on matching algorithm -->
                    <div class="list-group list-group-flush mt-3">
                        {% for i in range(1, 3) %}
                        {% set found = found_items[0] if found_items else None %}
                        {% if found %}
                        <a href="{{ url_for('view_found_item', item_id=found.id) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ found.title }}</h6>
                                <small>{{ found.date_found.strftime('%b %d') }}</small>
                            </div>
                            <small class="text-muted">{{ found.location_found }}</small>
                        </a>
                        {% else %}
                        <div class="list-group-item">
                            <p class="mb-0 text-muted">No similar items found</p>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="card-text">Check out these similar lost items that might match what you found:</p>
                    <!-- In a real app, we would show similar lost items based on matching algorithm -->
                    <div class="list-group list-group-flush mt-3">
                        {% for i in range(1, 3) %}
                        {% set lost = lost_items[0] if lost_items else None %}
                        {% if lost %}
                        <a href="{{ url_for('view_lost_item', item_id=lost.id) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ lost.title }}</h6>
                                <small>{{ lost.date_lost.strftime('%b %d') }}</small>
                            </div>
                            <small class="text-muted">{{ lost.location_lost }}</small>
                        </a>
                        {% else %}
                        <div class="list-group-item">
                            <p class="mb-0 text-muted">No similar items found</p>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="d-grid gap-2 mt-3">
                        <a href="{{ url_for('browse_items') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-list me-2"></i>Browse All Items
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Found Item Modal -->
<div class="modal fade" id="foundItemModal" tabindex="-1" aria-labelledby="foundItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="foundItemModalLabel">
                    <i class="fas fa-search-plus me-2"></i>I Found This Item
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('report_found_for_lost', item_id=item['id']) }}">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Help reunite this item with its owner!</strong> 
                        Fill out the details below to let the owner know you found their item.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="foundDate" class="form-label">When did you find it?</label>
                            <input type="date" class="form-control" id="foundDate" name="date_found" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="foundLocation" class="form-label">Where did you find it?</label>
                            <input type="text" class="form-control" id="foundLocation" name="location_found" 
                                   placeholder="Specific location where you found the item" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="foundDescription" class="form-label">Additional Details</label>
                        <textarea class="form-control" id="foundDescription" name="description" rows="3" 
                                  placeholder="Describe the condition of the item, any additional details that might help verify ownership..." required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contactInfo" class="form-label">Your Contact Information (Email preferred for privacy)</label>
                        <input type="text" class="form-control" id="contactInfo" name="contact_info" 
                               placeholder="Email address or phone number - email preferred for privacy" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="currentLocation" class="form-label">Where is the item now?</label>
                        <input type="text" class="form-control" id="currentLocation" name="current_location" 
                               placeholder="Where you're keeping the item or where it can be picked up" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Send to Owner
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">Report Issue</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="reportReason" class="form-label">Reason</label>
                        <select class="form-select" id="reportReason">
                            <option selected>Select a reason</option>
                            <option value="inappropriate">Inappropriate content</option>
                            <option value="spam">Spam or misleading</option>
                            <option value="duplicate">Duplicate posting</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reportDetails" class="form-label">Details</label>
                        <textarea class="form-control" id="reportDetails" rows="3" placeholder="Please provide additional information about the issue"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitReport()">Submit Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Show a temporary message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x" style="z-index: 1050; margin-top: 20px;" role="alert">
                    Link copied to clipboard!
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto dismiss after 3 seconds
            setTimeout(function() {
                document.querySelector('.alert').remove();
            }, 3000);
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
        });
    }
    
    function submitReport() {
        // This would normally submit the report to the server
        // For demo purposes, just show a success message and close the modal
        $('#reportModal').modal('hide');
        
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x" style="z-index: 1050; margin-top: 20px;" role="alert">
                Your report has been submitted. We'll review it shortly.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', alertHtml);
        
        // Auto dismiss after 3 seconds
        setTimeout(function() {
            document.querySelector('.alert').remove();
        }, 3000);
    }
</script>
{% endblock %}